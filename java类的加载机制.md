# 类的加载
类的加载指的是将类的.class文件中的二进制数据读入到内存中, 将其放置运行时数据区的方法区内, 然后再堆区创建一个java.lang.Class对象, 用来封装类在方法区内的数据结构.

类的加载的最终产品是位于堆区中的Class对象, Class对象封装了雷在方法区内的数据结构, 并向用户提供了访问方法区内的数据结构的接口.

![](http://images2015.cnblogs.com/blog/331425/201606/331425-20160621125940990-365229277.png)

### 加载.class的方式
- 从本地系统中直接加载
- 通过网络下载.class文件
- 从zip, jar等归档文件中加载.class文件
- 从专有数据库中提取.class文件
- 将java源文件动态编译为.class文件

### 类的生命周期
```
加载-->验证-->准备-->解析-->初始化
```
解析在某些情况下可能放在初始化后面.

### 加载
加载阶段需要完成三个步骤:
1. 通过一个类的全限定名来获取其定义的二进制字节流
2. 将字节流所代表的静态存储借口股转化为方法区的运行时数据结构
3. 在Java堆中生成一个代表这个类的`java.lang.Class`对象, 作为对方法区中这些数据的访问入口

### 验证
- 文件格式验证
- 元数据验证
- 字节码验证
- 符号引用验证

### 准备
为类静态变量分配内存, 并将其初始化为默认值
1. 这时候进行内存分配的仅包括类变量(static), 不包括实例变量, 实例变量在对象实例化时随着对象一起分配在Java堆中
2. 初始值通常是数据类型的初始值, 不是java代码中被显示的赋予的值.
```java
public static int value = 3;
```
变量value在准备阶段初始值为0, 而不是3, 因为这个时候尚未执行任何Java方法, 把value赋值为3的的指令putstatic指令是程序编译后, 存放在类构造器<clinit>()方法中, value赋值为3在初始化阶段才会执行

>  这里还需要注意如下几点：
  · 对基本数据类型来说，对于类变量（static）和全局变量，如果不显式地对其赋值而直接使用，则系统会为其赋予默认的零值，而对于局部变量来说，在使用前必须显式地为其赋值，否则编译时不通过。
  · 对于同时被static和final修饰的常量，必须在声明的时候就为其显式地赋值，否则编译时不通过；而只被final修饰的常量则既可以在声明时显式地为其赋值，也可以在类初始化时显式地为其赋值，总之，在使用前必须为其显式地赋值，系统不会为其赋予默认零值。
  · 对于引用数据类型reference来说，如数组引用、对象引用等，如果没有对其进行显式地赋值而直接使用，系统都会为其赋予默认的零值，即null。
  · 如果在数组初始化时没有对数组中的各元素赋值，那么其中的元素将根据对应的数据类型而被赋予默认的零值。

3. 如果类字段的字段属性表中存在ConstantValue值, 即同时被final和static修饰, 那么在准备阶段变量value就会被初始化为ConstValue属性所指定的值.
```java
public static final int value = 3;
```
编译时javac将会为value生成ConstantValue属性, 在准备阶段虚拟机就会根据ConstantValue设置为3.

### 解析
把类中的符号引用转换为直接引用
解析阶段是虚拟机将常量池内的符号引用替换为直接引用的过程, 解析动作主要针对类或接口, 字段, 类方法,接口方法, 方法类型, 方法句柄和调用点限定符7类符号引用.

- 符号引用是一组符号来描述目标, 可以是任何字面量.
- 直接引用是直接指向目标的指针, 相对偏移量或一个间接定位到目标的句柄

### 初始化
为静态变量赋予正确的初始值, JVM负责对类进行初始化, 主要对类变量进行初始化.
1. 声明类变量是指定初始值
2. 使用静态代码块为类变量指定初始值

初始化步骤:
1. 加入这个类还没有被加载和连接, 则程序先加载并连接该类
2. 假如该类的直接父类还没有初始化, 则先初始化器直接父类
3. 加入类中有初始化语句, 则系统一次执行这些初始化语句

类初始化时机:
- 创建类的实例, 使用new创建类实例
- 访问某个类或接口的静态变量, 或者对该静态变量赋值
- 调用类的静态方法
- 反射
- 初始化某个类的子类, 则其父类也会被初始化
- Java虚拟机启动时被表明为启动类的类, 直接使用java命令来运行的某个主类

### 结束生命周期
- 执行了System.exit()方法
- 程序正常结束
- 程序执行过程中遇到了异常或者错误而异常终止
- 由于操作系统出现错误而导致Java虚拟机进程终止
